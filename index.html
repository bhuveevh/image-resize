<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Image Compressor</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input[type="file"] { margin-top: 10px; }
  input[type="range"] { width: 100%; }
  img { max-width: 100%; margin-top: 15px; border: 1px solid #ccc; }
  button { margin-top: 15px; padding: 10px 20px; font-size: 1rem; cursor: pointer; }
  #outputInfo { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<h2>Image Compressor with Resize & Quality</h2>

<label>Select Image (JPEG/PNG):</label>
<input type="file" id="fileInput" accept="image/jpeg,image/png" />

<label>Target Size (KB): <span id="targetSizeLabel">100</span> KB</label>
<input type="range" id="sizeRange" min="10" max="1000" value="100" />

<label>Image Scale (%): <span id="scaleLabel">100</span>%</label>
<input type="range" id="scaleRange" min="10" max="100" value="100" />

<label>Select Format:</label>
<select id="formatSelect">
  <option value="image/jpeg">JPEG</option>
  <option value="image/png">PNG</option>
</select>

<button id="compressBtn" disabled>Compress & Download</button>

<div id="outputInfo"></div>
<img id="preview" hidden alt="Compressed Preview" />

<script>
  const fileInput = document.getElementById("fileInput");
  const sizeRange = document.getElementById("sizeRange");
  const scaleRange = document.getElementById("scaleRange");
  const targetSizeLabel = document.getElementById("targetSizeLabel");
  const scaleLabel = document.getElementById("scaleLabel");
  const formatSelect = document.getElementById("formatSelect");
  const compressBtn = document.getElementById("compressBtn");
  const outputInfo = document.getElementById("outputInfo");
  const preview = document.getElementById("preview");

  let originalImage = null;

  // Update labels
  sizeRange.addEventListener("input", () => {
    targetSizeLabel.textContent = sizeRange.value;
  });
  scaleRange.addEventListener("input", () => {
    scaleLabel.textContent = scaleRange.value;
  });

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;
    if (!file.type.match(/image\/(jpeg|png)/)) {
      alert("Please select a JPEG or PNG image.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = () => {
        originalImage = img;
        preview.src = e.target.result;
        preview.hidden = false;
        compressBtn.disabled = false;
        outputInfo.textContent = `Original Size: ${(file.size / 1024).toFixed(2)} KB`;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  compressBtn.addEventListener("click", async () => {
    if (!originalImage) return;
    compressBtn.disabled = true;
    outputInfo.textContent = "Compressing... Please wait.";
    try {
      const compressedDataUrl = await compressImageWithResize();
      preview.src = compressedDataUrl;

      // Calculate final size
      const base64Length = compressedDataUrl.length - compressedDataUrl.indexOf(",") - 1;
      const approxSizeKB = Math.round((base64Length * 3) / 4 / 1024 * 100) / 100;

      outputInfo.textContent = `Output Size: ~${approxSizeKB} KB (Target: ${sizeRange.value} KB)`;

      // Create temporary download link
      const a = document.createElement("a");
      a.href = compressedDataUrl;
      a.download = "compressed-image." + (formatSelect.value === "image/png" ? "png" : "jpg");
      a.click();

    } catch (e) {
      outputInfo.textContent = "Compression failed: " + e.message;
    }
    compressBtn.disabled = false;
  });

  async function compressImageWithResize() {
    const format = formatSelect.value;
    const targetSizeKB = parseInt(sizeRange.value);
    const tolerance = 0.005; // 0.5%
    let scale = parseFloat(scaleRange.value) / 100;

    let width = Math.floor(originalImage.width * scale);
    let height = Math.floor(originalImage.height * scale);

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = width;
    canvas.height = height;

    ctx.drawImage(originalImage, 0, 0, width, height);

    // For PNG, quality param is ignored by toDataURL; so if PNG, skip quality adjustments
    if (format === "image/png") {
      return canvas.toDataURL(format);
    }

    // For JPEG, do binary search on quality to meet target size approx
    let lowQ = 0.1;
    let highQ = 0.95;
    let quality = 0.9;

    function dataURLtoKB(dataURL) {
      // Calculate approx size in KB from base64 string length
      let base64Length = dataURL.length - dataURL.indexOf(",") - 1;
      return (base64Length * 3) / 4 / 1024;
    }

    let output = canvas.toDataURL(format, quality);
    let outputSizeKB = dataURLtoKB(output);

    while ((highQ - lowQ) > 0.01) {
      if (outputSizeKB > targetSizeKB * (1 + tolerance)) {
        highQ = quality;
        quality = (lowQ + quality) / 2;
      } else if (outputSizeKB < targetSizeKB * (1 - tolerance)) {
        lowQ = quality;
        quality = (quality + highQ) / 2;
      } else {
        break;
      }
      output = canvas.toDataURL(format, quality);
      outputSizeKB = dataURLtoKB(output);
    }

    return output;
  }
</script>

</body>
</html>
